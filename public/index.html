<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TEEG Table</title>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #0b3d2e;
  color: white;
}

#table-container {
  position: relative;
  width: 100vw;
  height: 100vh;
}

#table {
  position: absolute;
  inset: 60px 0 0 0;
}

/* Player positions */
.player {
  position: absolute;
  width: 160px;
  text-align: center;
}
.player.top { top: 10px; left: 50%; transform: translateX(-50%); }
.player.bottom { bottom: 20px; left: 50%; transform: translateX(-50%); }
.player.left { left: 20px; top: 50%; transform: translateY(-50%); }
.player.right { right: 20px; top: 50%; transform: translateY(-50%); }

.cards-row {
  display: flex;
  justify-content: center;
  margin: 4px 0;
}

.card {
  width: 46px;
  height: 64px;
  border-radius: 6px;
  background: white;
  color: black;
  margin: 0 3px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  cursor: pointer;
  user-select: none;
}

.card.back {
  background: #222;
  border: 1px solid #555;
}

.selected {
  transform: translateY(-10px);
  box-shadow: 0 8px 18px gold;
  border: 2px solid gold;
}

/* Piles */
#play-pile, #draw-pile {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
}
#play-pile { left: 50%; transform: translate(-50%, -50%); }
#draw-pile { left: calc(50% + 90px); }

.pile-card {
  position: absolute;
  width: 46px;
  height: 64px;
  border-radius: 6px;
  background: white;
  color: black;
  display: flex;
  align-items: center;
  justify-content: center;
}

.pile-count {
  position: absolute;
  bottom: -8px;
  right: -8px;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: red;
  font-size: 11px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* HUD */
#hud {
  position: fixed;
  top: 6px;
  left: 50%;
  transform: translateX(-50%);
  text-align: center;
}
#hud input { padding: 4px; }

#bomb, #teeg {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  font-size: 48px;
  z-index: 999;
}
#bomb { background: red; }
#teeg { background: black; color: red; flex-direction: column; }
</style>
</head>

<body>

<div id="table-container">
  <div id="table"></div>

  <div id="hud">
    <input id="playerName" placeholder="Your name">
    <button onclick="createRoom()">Create</button>
    <input id="roomInput" placeholder="Room">
    <button onclick="joinRoom()">Join</button>
    <div id="turn"></div>
    <button onclick="playSelected()">Play Selected</button>
  </div>

  <div id="play-pile"></div>
  <div id="draw-pile"><div class="card back"></div></div>

  <div id="bomb">ðŸ’¥ BOMB ðŸ’¥</div>
  <div id="teeg"><div id="teegText"></div><button onclick="alert(`YOU'RE SHIT ðŸ˜ˆ`)">YOU'RE SHIT</button></div>
</div>

<script>
const socket = io("https://teeg-server.onrender.com", { transports:["polling"], forceNew:true });

let myId="", roomId="", lastState=null;
let selectedIndexes=[], selectedValue=null;

/* ROOM */
function createRoom(){
  const name=playerName.value.trim();
  if(!name) return alert("Enter name");
  socket.emit("create-room",name,id=>roomId=id);
}
function joinRoom(){
  const name=playerName.value.trim();
  roomId=roomInput.value.trim();
  if(!name||!roomId) return;
  socket.emit("join-room",{roomId,name});
}

/* STATE */
socket.on("state",state=>{
  lastState=state;
  selectedIndexes=[]; selectedValue=null;
  const table=document.getElementById("table");
  table.innerHTML="";

  const current=state.players[state.turn];
  turn.innerText=current.id===myId?"ðŸ‘‰ YOUR TURN":"Waiting for "+current.name;

  state.players.forEach((p,i)=>{
    const div=document.createElement("div");
    div.className="player "+["top","bottom","left","right"][i];

    const name=document.createElement("div");
    name.innerText=p.name+(p.id===current.id?" â­":"");
    div.appendChild(name);

    const fd=document.createElement("div"); fd.className="cards-row";
    (p.faceDown||[]).forEach(()=>fd.appendChild(cardBack()));
    div.appendChild(fd);

    const fu=document.createElement("div"); fu.className="cards-row";
    (p.faceUp||[]).forEach((c,idx)=>{
      const card=cardFront(c);
      if(p.id===myId&&p.stage==="faceUp"){
        card.onclick=()=>toggleCard(c,idx);
      }
      fu.appendChild(card);
    });
    div.appendChild(fu);

    if(p.id===myId&&p.stage==="hand"){
      const hand=document.createElement("div"); hand.className="cards-row";
      p.hand.forEach((c,idx)=>{
        const card=cardFront(c);
        if(selectedIndexes.includes(idx)) card.classList.add("selected");
        card.onclick=()=>toggleCard(c,idx);
        hand.appendChild(card);
      });
      div.appendChild(hand);
    }

    if(p.id===myId&&p.stage==="faceDown"){
      const fdPlay=document.createElement("div"); fdPlay.className="cards-row";
      p.faceDown.forEach(()=>{
        const c=cardBack();
        c.innerText="ðŸ‚ ";
        c.onclick=()=>socket.emit("play",{roomId,card:"UNKNOWN"});
        fdPlay.appendChild(c);
      });
      div.appendChild(fdPlay);
    }

    table.appendChild(div);
  });

  /* Play pile */
  const pp=document.getElementById("play-pile");
  pp.innerHTML="";
  const counts={};
  state.pile.forEach(c=>counts[c]=(counts[c]||0)+1);
  Object.entries(counts).forEach(([c,n],i)=>{
    const card=cardFront(c);
    card.style.top=i*4+"px";
    if(n>1){
      const cnt=document.createElement("div");
      cnt.className="pile-count"; cnt.innerText=n;
      card.appendChild(cnt);
    }
    pp.appendChild(card);
  });
});

/* HELPERS */
function cardFront(v){
  const d=document.createElement("div");
  d.className="card"; d.innerText=v;
  return d;
}
function cardBack(){
  const d=document.createElement("div");
  d.className="card back";
  return d;
}

/* MULTI SELECT */
function toggleCard(card,idx){
  if(lastState.players[lastState.turn].id!==myId) return;
  if(selectedValue===null||selectedValue!==card){
    selectedValue=card; selectedIndexes=[idx];
  }else if(selectedIndexes.includes(idx)){
    selectedIndexes=selectedIndexes.filter(i=>i!==idx);
    if(!selectedIndexes.length) selectedValue=null;
  }else selectedIndexes.push(idx);
}

/* PLAY */
function playSelected(){
  if(!selectedIndexes.length) return;
  const me=lastState.players.find(p=>p.id===myId);
  const cards=selectedIndexes.map(i=>me.hand[i]??me.faceUp[i]);
  socket.emit("play",{roomId,cards});
  selectedIndexes=[]; selectedValue=null;
}

/* EFFECTS */
socket.on("bomb",()=>{bomb.style.display="flex";setTimeout(()=>bomb.style.display="none",800);});
socket.on("game-over",d=>{teeg.style.display="flex";teegText.innerText=d.teeg+" IS THE TEEG";});
socket.on("connect",()=>myId=socket.id);
</script>

</body>
</html>


