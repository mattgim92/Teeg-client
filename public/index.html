<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TEEG</title>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  background: #064b2c;
  font-family: Arial, sans-serif;
  user-select: none;
}

/* ================= TABLE ================= */

#table {
  position: relative;
  width: 100%;
  height: 100%;
  background: radial-gradient(circle at center, #0b6b3a 0%, #04391f 70%);
  overflow: hidden;
}

/* ================= PLAYERS ================= */

.player {
  position: absolute;
  width: 400px;
  height: 180px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.player.bottom { bottom: 10px; left: 50%; transform: translateX(-50%); }
.player.top    { top: 10px; left: 50%; transform: translateX(-50%); }
.player.left   { left: 10px; top: 50%; transform: translateY(-50%) rotate(90deg); }
.player.right  { right: 10px; top: 50%; transform: translateY(-50%) rotate(-90deg); }

.player-name {
  color: white;
  margin-bottom: 5px;
  font-weight: bold;
}

/* ================= CARDS ================= */

.card {
  position: absolute;
  width: 60px;
  height: 85px;
  border-radius: 6px;
  background: white;
  color: black;
  display: flex;
  justify-content: center;
  align-items: center;
  font-weight: bold;
  font-size: 18px;
  box-shadow: 0 3px 6px rgba(0,0,0,0.5);
  transition: transform 0.15s ease;
}

.card.back {
  background: #1a1a1a;
  border: 1px solid #555;
  color: transparent;
}

.card.selected {
  transform: translateY(-20px);
  outline: 2px solid gold;
}

/* ================= HAND ================= */

.hand {
  position: relative;
  width: 100%;
  height: 120px;
}

/* ================= FACE UP / DOWN ================= */

.face-zone {
  position: relative;
  width: 100%;
  height: 90px;
}

/* ================= PILES ================= */

#play-pile, #draw-pile {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  width: 80px;
  height: 110px;
}

#play-pile { left: 50%; transform: translate(-50%, -50%); }
#draw-pile { left: calc(50% + 120px); }

.pile-count {
  position: absolute;
  bottom: -10px;
  right: -10px;
  width: 22px;
  height: 22px;
  background: red;
  color: white;
  border-radius: 50%;
  font-size: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ================= HUD ================= */

#hud {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  text-align: center;
  color: white;
}

#hud input, #hud button {
  padding: 5px;
  margin: 2px;
}
</style>
</head>

<body>

<div id="table">

  <div id="hud">
    <input id="playerName" placeholder="Name">
    <button onclick="createRoom()">Create</button>
    <input id="roomInput" placeholder="Room">
    <button onclick="joinRoom()">Join</button>
    <div id="turn"></div>
    <button onclick="playSelected()">Play</button>
  </div>

  <div id="play-pile"></div>
  <div id="draw-pile"></div>

</div>

<script>
/* ================= SOCKET ================= */

const socket = io("https://teeg-server.onrender.com",{transports:["polling"]});
let myId = "";
let roomId = "";
let lastState = null;
let selectedIndexes = [];
let selectedValue = null;

socket.on("connect", () => myId = socket.id);

/* ================= ROOM ================= */

function createRoom() {
  const name = playerName.value.trim();
  if (!name) return;
  socket.emit("create-room", name, id => roomId = id);
}

function joinRoom() {
  const name = playerName.value.trim();
  roomId = roomInput.value.trim();
  if (!name || !roomId) return;
  socket.emit("join-room", { roomId, name });
}

/* ================= STATE ================= */

socket.on("state", state => {
  lastState = state;
  document.querySelectorAll(".player").forEach(p => p.remove());

  const positions = ["bottom","top","left","right"];

  const current = state.players[state.turn];
  turn.innerText = current.id === myId ? "YOUR TURN" : current.name + "'s turn";

  state.players.forEach((p, i) => renderPlayer(p, positions[i]));
  renderPiles(state);
});

/* ================= RENDER PLAYER ================= */

function renderPlayer(player, pos) {
  const el = document.createElement("div");
  el.className = "player " + pos;

  const name = document.createElement("div");
  name.className = "player-name";
  name.innerText = player.name;
  el.appendChild(name);

  renderFaceCards(el, player);
  renderHand(el, player);

  document.getElementById("table").appendChild(el);
}

/* ================= FACE UP / DOWN ================= */

function renderFaceCards(el, p) {
  const zone = document.createElement("div");
  zone.className = "face-zone";

  (p.faceDown || []).forEach((_, i) => {
    const c = createCard("?", true);
    c.style.left = (i * 22) + "px";
    zone.appendChild(c);
  });

  (p.faceUp || []).forEach((v, i) => {
    const c = createCard(v);
    c.style.left = (i * 22) + "px";
    if (p.id === myId && p.stage === "faceUp") {
      c.onclick = () => socket.emit("play",{roomId,card:v});
    }
    zone.appendChild(c);
  });

  el.appendChild(zone);
}

/* ================= HAND ================= */

function renderHand(el, p) {
  const hand = document.createElement("div");
  hand.className = "hand";

  if (p.id === myId && p.stage === "hand") {
    p.hand.forEach((v, i) => {
      const c = createCard(v);
      c.style.left = (i * 45) + "px";
      if (selectedIndexes.includes(i)) c.classList.add("selected");
      c.onclick = () => toggleCard(v, i);
      hand.appendChild(c);
    });
  } else {
    (p.hand || []).forEach((_, i) => {
      const c = createCard("?", true);
      c.style.left = (i * 12) + "px";
      hand.appendChild(c);
    });
  }

  el.appendChild(hand);
}

/* ================= CARD ================= */

function createCard(value, back=false) {
  const c = document.createElement("div");
  c.className = "card" + (back ? " back" : "");
  c.innerText = back ? "" : value;
  return c;
}

/* ================= MULTI SELECT ================= */

function toggleCard(val, idx) {
  if (!lastState) return;
  const me = lastState.players[lastState.turn];
  if (me.id !== myId) return;

  if (selectedValue === null || selectedValue !== val) {
    selectedValue = val;
    selectedIndexes = [idx];
  } else if (selectedIndexes.includes(idx)) {
    selectedIndexes = selectedIndexes.filter(i => i !== idx);
    if (!selectedIndexes.length) selectedValue = null;
  } else {
    selectedIndexes.push(idx);
  }
  socket.emit("request-state");
}

/* ================= PLAY ================= */

function playSelected() {
  if (!selectedIndexes.length) return;
  const me = lastState.players.find(p => p.id === myId);
  const cards = selectedIndexes.map(i => me.hand[i]);
  socket.emit("play", { roomId, cards });
  selectedIndexes = [];
  selectedValue = null;
}

/* ================= PILES ================= */

function renderPiles(state) {
  const play = document.getElementById("play-pile");
  const draw = document.getElementById("draw-pile");
  play.innerHTML = "";
  draw.innerHTML = "";

  const counts = {};
  state.pile.forEach(c => counts[c] = (counts[c] || 0) + 1);

  Object.keys(counts).forEach((v, i) => {
    const c = createCard(v);
    c.style.top = (i * 3) + "px";
    play.appendChild(c);
    if (counts[v] > 1) {
      const n = document.createElement("div");
      n.className = "pile-count";
      n.innerText = counts[v];
      c.appendChild(n);
    }
  });

  draw.appendChild(createCard("?", true));
}
</script>

</body>
</html>



